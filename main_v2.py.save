import requests
import torch
import oci
import os
import json
from PIL import Image, ImageStat
from io import BytesIO
from transformers import CLIPProcessor, CLIPModel

# ==========================================
# âš™ï¸ USER CONFIGURATION (EDIT THIS SECTION)
# ==========================================
CAT_API_KEY = 'YOUR_CAT_API_KEY_HERE' 
OCI_NAMESPACE = 'YOUR_NAMESPACE_HERE'
OCI_BUCKET_NAME = 'reddit-segregated' # Keep this if your bucket name is same

# ==========================================
# ðŸ§  AI MODEL LOADING
# ==========================================
print("Loading AI Brain (CLIP)... this takes 10-20 seconds.")
# We use the Base model. It fits easily in your 24GB RAM.
MODEL_ID = "openai/clip-vit-base-patch32"
model = CLIPModel.from_pretrained(MODEL_ID)
processor = CLIPProcessor.from_pretrained(MODEL_ID)

# ==========================================
# ðŸ”§ HELPER FUNCTIONS
# ==========================================

def get_warmth(img):
    """
    Determines if lighting is Warm (Red/Yellow) or Cool (Blue).
    """
    stat = ImageStat.Stat(img)
    r, g, b = stat.mean
    # If Red is dominant over Blue, it's Warm.
    return "Warm" if r > b else "Cool"

def get_vibe(img):
    """
    Uses OpenAI CLIP to classify the 'vibe' of the cat.
    """
    labels = ["a funny goofy cat", "a normal calm cat"]
    inputs = processor(text=labels, images=img, return_tensors="pt", padding=True)
    
    with torch.no_grad():
        outputs = model(**inputs)
        
    # Convert raw scores to probabilities
    probs = outputs.logits_per_image.softmax(dim=1)
    funny_score = probs[0][0].item() # Score for "funny goofy cat"
    
    # If AI is >60% sure it's funny, tag it Funny.
    if funny_score > 0.6:
        return "Funny"
    else:
        return "Normal"

def upload_to_oracle(file_content, destination_path):
    """
    Uploads the image file to Oracle Object Storage.
    """
    try:
        # Load the config we created in ~/.oci/config
        config = oci.config.from_file()
        object_storage = oci.object_storage.ObjectStorageClient(config)
        
        object_storage.put_object(
            OCI_NAMESPACE,
            OCI_BUCKET_NAME,
            destination_path,
            file_content
        )
        return True
    except Exception as e:
        print(f"âŒ Upload Error: {e}")
        return False

def fetch_cats():
    """
    Gets 10 random cat images from The Cat API.
    """
    url = "https://api.thecatapi.com/v1/images/search?limit=10"
    headers = {'x-api-key': CAT_API_KEY}
    
    try:
        response = rimport requests
import torch
import oci
import os
import json
from PIL import Image, ImageStat
from io import BytesIO
from transformers import CLIPProcessor, CLIPModel

# ==========================================
# âš™ï¸ USER CONFIGURATION (EDIT THIS SECTION)
# ==========================================
CAT_API_KEY = 'YOUR_CAT_API_KEY_HERE' 
OCI_NAMESPACE = 'YOUR_NAMESPACE_HERE'
OCI_BUCKET_NAME = 'reddit-segregated' # Keep this if your bucket name is same

# ==========================================
# ðŸ§  AI MODEL LOADING
# ==========================================
print("Loading AI Brain (CLIP)... this takes 10-20 seconds.")
# We use the Base model. It fits easily in your 24GB RAM.
MODEL_ID = "openai/clip-vit-base-patch32"
model = CLIPModel.from_pretrained(MODEL_ID)
processor = CLIPProcessor.from_pretrained(MODEL_ID)

# ==========================================
# ðŸ”§ HELPER FUNCTIONS
# ==========================================

def get_warmth(img):
    """
    Determines if lighting is Warm (Red/Yellow) or Cool (Blue).
    """
    stat = ImageStat.Stat(img)
    r, g, b = stat.mean
    # If Red is dominant over Blue, it's Warm.
    return "Warm" if r > b else "Cool"

def get_vibe(img):
    """
    Uses OpenAI CLIP to classify the 'vibe' of the cat.
    """
    labels = ["a funny goofy cat", "a normal calm cat"]
    inputs = processor(text=labels, images=img, return_tensors="pt", padding=True)
    
    with torch.no_grad():
        outputs = model(**inputs)
        
    # Convert raw scores to probabilities
    probs = outputs.logits_per_image.softmax(dim=1)
    funny_score = probs[0][0].item() # Score for "funny goofy cat"
    
    # If AI is >60% sure it's funny, tag it Funny.
    if funny_score > 0.6:
        return "Funny"
    else:
        return "Normal"

def upload_to_oracle(file_content, destination_path):
    """
    Uploads the image file to Oracle Object Storage.
    """
    try:
        # Load the config we created in ~/.oci/config
        config = oci.config.from_file()
        object_storage = oci.object_storage.ObjectStorageClient(config)
        
        object_storage.put_object(
            OCI_NAMESPACE,
            OCI_BUCKET_NAME,
            destination_path,
            file_content
        )
        return True
    except Exception as e:
        print(f"âŒ Upload Error: {e}")
        return False

def fetch_cats():
    """
    Gets 10 random cat images from The Cat API.
    """
    url = "https://api.thecatapi.com/v1/images/search?limit=10"
    headers = {'x-api-key': CAT_API_KEY}
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json()
        else:
            print(f"âš ï¸ API Error: Status {response.status_code}")
            return []
    except Exception as e:
        print(f"âš ï¸ Connection Error: {e}")
        return []

# ==========================================
# ðŸš€ MAIN EXECUTION
# ==========================================
def main():
    print("---------------------------------------")
    print("ðŸ± Starting Cat Segregator v2...")
    
    cats = fetch_cats()
    print(f"ðŸ“¥ Found {len(cats)} cats to process.")
    
    for cat in cats:
        img_url = cat['url']
        img_id = cat['id']
        
        try:
            # 1. Download Image
            response = requests.get(img_url)
            img_data = BytesIO(response.content)
            img = Image.open(img_data).convert('RGB')
            
            # 2. AI Analysis
            warmth = get_warmth(img)  # "Warm" or "Cool"
            vibe = get_vibe(img)      # "Funny" or "Normal"
            
            # 3. Segregation (Folder Naming)
            # Example: Warm/Funny/abc1234.jpg
            filename = f"{img_id}.jpg"
            cloud_path = f"{warmth}/{vibe}/{filename}"
            
            print(f"âœ… Processing: {filename} -> [{warmth} | {vibe}]")
            
            # 4. Upload to Cloud
            img_data.seek(0) # Reset file pointer
            upload_to_oracle(img_data, cloud_path)
            
        except Exception as e:
            print(f"âŒ Failed on {img_id}: {e}")

    print("ðŸŽ‰ Batch Complete.")
    print("---------------------------------------")

if __name__ == "__main__":
    main()equests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json()
        else:
            print(f"âš ï¸ API Error: Status {response.status_code}")
            return []
    except Exception as e:
        print(f"âš ï¸ Connection Error: {e}")
        return []

# ==========================================
# ðŸš€ MAIN EXECUTION
# ==========================================
def main():
    print("---------------------------------------")
    print("ðŸ± Starting Cat Segregator v2...")
    
    cats = fetch_cats()
    print(f"ðŸ“¥ Found {len(cats)} cats to process.")
    
    for cat in cats:
        img_url = cat['url']
        img_id = cat['id']
        
        try:
            # 1. Download Image
            response = requests.get(img_url)
            img_data = BytesIO(response.content)
            img = Image.open(img_data).convert('RGB')
            
            # 2. AI Analysis
            warmth = get_warmth(img)  # "Warm" or "Cool"
            vibe = get_vibe(img)      # "Funny" or "Normal"
            
            # 3. Segregation (Folder Naming)
            # Example: Warm/Funny/abc1234.jpg
            filename = f"{img_id}.jpg"
            cloud_path = f"{warmth}/{vibe}/{filename}"
            
            print(f"Processing: {filename} -> [{warmth} | {vibe}]")
            
            # 4. Upload to Cloud
            img_data.seek(0) # Reset file pointer
            upload_to_oracle(img_data, cloud_path)
            
        except Exception as e:
            print(f"Failed on {img_id}: {e}")

    print("ðŸŽ‰ Batch Complete.")
    print("---------------------------------------")

if __name__ == "__main__":
    main()
